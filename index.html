<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/png" href="favicon.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vantage Renderer</title>
  </head>

  <body>
    <section>
      <vantage-renderer
        scene="./media/scene.gltf"
        controls="edit"
        first-person="false"
        style="pointer-events: auto"
        time="0"
      >
        <vantage-projection id="projection-1" src="./media/aerial.jpg" projection-type="map">
          <vantage-keyframe
            position="0 500 0"
            rotation="-1.5708 -1.5708 0"
            far="501"
            time="0"
          ></vantage-keyframe>
        </vantage-projection>
        <vantage-projection
          id="projection-2"
          src="https://media.thometnanni.net/long-story.mp4"
          layers="Buildings Ground"
          focus
        >
          <vantage-keyframe
            position="-21.000150790288302 0.9300571526624671 32.01275514342212"
            rotation="0.09000000000000065 -0.6939999999999961 -2.786836633470502e-17"
            fov="44.40000000000003"
            far="30"
            time="0.0"
            screen="true"
          ></vantage-keyframe>
          <vantage-keyframe
            position="-10 0.9300571526624671 30.421468453725566"
            rotation="0.08599999999999962 -0.5200000000000005 -1.7411583119434143e-17"
            fov="61"
            far="63"
            time="5.0"
            screen="true"
          ></vantage-keyframe>
        </vantage-projection>
        <vantage-projection id="projection-3" src="./media/IMG_3271.jpeg">
          <vantage-keyframe
            position="38.89105577493452 1.596007992385184 15.467554987397904"
            rotation="0.023999999999999657 -1.5800000000000094 2.602834794405102e-17"
            fov="53"
            far="84"
            layers="Buildings Ground"
            screen="true"
            opacity=".8"
            time="2.0"
          ></vantage-keyframe>
        </vantage-projection>
        <vantage-projection id="projection-4" src="./media/prinz-1.jpg">
          <vantage-keyframe
            position="332.7978567718118 1.4705038647204838 -74.16062977140834"
            rotation="0.1419999999999997 1.1220000000000068 6.16831112026121e-16"
            fov="63"
            far="66"
            layers="Buildings Ground"
            screen="true"
            time="3.0"
          ></vantage-keyframe>
        </vantage-projection>
        <vantage-projection id="projection-5" src="./media/prinz-2.jpg">
          <vantage-keyframe
            position="300.3924330507958 1 -61.9849352551449"
            rotation="0.018000000000001147 -0.3719999999999884 1.1034628868824297e-15"
            fov="63"
            far="85"
            layers="Buildings Ground"
            screen="true"
            time="4.0"
          ></vantage-keyframe>
        </vantage-projection>
        <vantage-projection id="projection-6" src="./media/warthe-eck.jpg">
          <vantage-keyframe
            position="133.29314431075227 4.324259787050994 -38.42700744166996"
            rotation="-0.020000000000008112 -2.0780000000000403 5.703176662847664e-15"
            fov="72"
            far="78"
            layers="Buildings Ground"
            screen="true"
            time="5.0"
          ></vantage-keyframe>
        </vantage-projection>
      </vantage-renderer>
    </section>

    <div class="controls">
      <div>
        <h3>Media</h3>
        <select id="projectionSelector">
          <option value="projection-2">Camera 2</option>
          <option value="projection-3">Camera 3</option>
          <option value="projection-4">Camera 4</option>
          <option value="projection-5">Camera 5</option>
          <option value="projection-6">Camera 6</option>
          <option value="projection-1">Camera 1 (Map)</option>
        </select>
      </div>
      <div>
        <h3>Keyframe</h3>
        <select id="keyframeSelector"></select>
      </div>
      <div>
        <h3>Camera Positioning</h3>
        <label>X: <input id="posX" type="number" step="1" /></label>
        <label>Y: <input id="posY" type="number" step="1" /></label>
        <label>Z: <input id="posZ" type="number" step="1" /></label>
      </div>
      <div>
        <h4>Rotation</h4>
        <label>X: <input id="rotX" type="number" step="0.1" /></label>
        <label>Y: <input id="rotY" type="number" step="0.1" /></label>
        <label>Z: <input id="rotZ" type="number" step="0.1" /></label>
      </div>
      <div>
        <h4>Depth</h4>
        <label>Far: <input id="far" type="number" step="1" /></label>
        <label>Field of View: <input id="fov" type="number" step="1" /></label>
      </div>
      <div>
        <h4>Keyframe Time</h4>
        <label>Time: <input id="keyframeTime" type="number" step="0.1" /></label>
      </div>
      <div>
        <h4>Project on:</h4>
        <label><input type="checkbox" id="layerBuildings" />Buildings</label>
        <label><input type="checkbox" id="layerGround" />Ground</label>
        <label><input type="checkbox" id="layerPlane" />Plane</label>
      </div>
      <div>
        <label>Opacity: <input id="opacity" type="number" min="0" max="1" step="0.1" /></label>
      </div>
      <button onclick="toggleFirstPerson()">Toggle First Person</button>
      <div>
        <h4>Time</h4>
        <input
          id="time"
          type="range"
          step="0.04"
          min="0"
          max="12"
          oninput="updateTime(event)"
          value="0"
        />
        <button id="playButton">Play</button>
      </div>
    </div>
    <div class="info">
      ©️
      <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>
      contributors
    </div>

    <script type="module" src="/src/main.js"></script>
    <script>
      const maxTime = 15
      let isPlaying = false
      let lastTimestamp = 0

      function updateKeyframeControls(keyframe) {
        const pos = (keyframe.getAttribute('position') || '0 0 0').split(' ')
        document.getElementById('posX').value = pos[0]
        document.getElementById('posY').value = pos[1]
        document.getElementById('posZ').value = pos[2]

        const rot = (keyframe.getAttribute('rotation') || '0 0 0').split(' ')
        document.getElementById('rotX').value = parseFloat(rot[0]).toFixed(2)
        document.getElementById('rotY').value = parseFloat(rot[1]).toFixed(2)
        document.getElementById('rotZ').value = parseFloat(rot[2]).toFixed(2)

        document.getElementById('fov').value = keyframe.getAttribute('fov') || ''
        document.getElementById('far').value = keyframe.getAttribute('far') || ''
        document.getElementById('opacity').value = keyframe.getAttribute('opacity') || '1'
        document.getElementById('keyframeTime').value = keyframe.getAttribute('time') || '0'
      }

      function observeKeyframe(keyframe) {
        const observer = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
            if (mutation.type === 'attributes') {
              updateKeyframeControls(keyframe)
            }
          })
        })
        observer.observe(keyframe, { attributes: true })
      }

      document.addEventListener('DOMContentLoaded', () => {
        const selector = document.getElementById('projectionSelector')
        document.querySelectorAll('vantage-keyframe').forEach((kf) => {
          observeKeyframe(kf)
          updateKeyframeControls(kf)
        })

        document.querySelector('.controls').addEventListener('input', (e) => {
          if (e.target.matches('input[type="number"], input[type="checkbox"]')) {
            const proj = document.getElementById(selector.value)
            const keyframe = getSelectedKeyframe(proj)
            if (!keyframe) return
            const posX = parseFloat(document.getElementById('posX').value) || 0
            const posY = parseFloat(document.getElementById('posY').value) || 0
            const posZ = parseFloat(document.getElementById('posZ').value) || 0
            keyframe.setAttribute('position', `${posX} ${posY} ${posZ}`)

            const rotX = parseFloat(document.getElementById('rotX').value) || 0
            const rotY = parseFloat(document.getElementById('rotY').value) || 0
            const rotZ = parseFloat(document.getElementById('rotZ').value) || 0
            keyframe.setAttribute('rotation', `${rotX} ${rotY} ${rotZ}`)

            const fov = document.getElementById('fov').value
            if (fov !== '') {
              keyframe.setAttribute('fov', parseFloat(fov))
            } else {
              keyframe.removeAttribute('fov')
            }
            const far = document.getElementById('far').value
            if (far !== '') {
              keyframe.setAttribute('far', parseFloat(far))
            } else {
              keyframe.removeAttribute('far')
            }
            const opacity = document.getElementById('opacity').value
            if (opacity !== '') {
              keyframe.setAttribute('opacity', parseFloat(opacity))
            } else {
              keyframe.removeAttribute('opacity')
            }
            const buildings = document.getElementById('layerBuildings').checked
            const ground = document.getElementById('layerGround').checked
            const screen = document.getElementById('layerPlane').checked
            const newLayers = []
            if (buildings) newLayers.push('Buildings')
            if (ground) newLayers.push('Ground')
            if (newLayers.length) {
              keyframe.setAttribute('layers', newLayers.join(' '))
            } else {
              keyframe.removeAttribute('layers')
            }
            keyframe.setAttribute('screen', screen ? true : false)
            const keyTime = document.getElementById('keyframeTime').value
            keyframe.setAttribute('time', parseFloat(keyTime))
            document.querySelector('vantage-renderer').setAttribute('time', keyTime)
          }
        })

        selector.addEventListener('change', () => selectProjection(selector.value))
        selectProjection(selector.value)
      })

      function playLoop(timestamp) {
        if (!lastTimestamp) lastTimestamp = timestamp
        const delta = (timestamp - lastTimestamp) / 1000
        lastTimestamp = timestamp
        if (isPlaying) {
          const rendererEl = document.querySelector('vantage-renderer')
          let currentTime = parseFloat(rendererEl.getAttribute('time')) || 0
          currentTime += delta
          if (currentTime > maxTime) currentTime = 0
          rendererEl.setAttribute('time', currentTime)
          document.getElementById('time').value = currentTime
          const proj = document.getElementById(document.getElementById('projectionSelector').value)
          populateKeyframeSelector(proj)
          loadProjectionValues(proj)
        }
        requestAnimationFrame(playLoop)
      }

      document.getElementById('playButton').addEventListener('click', () => {
        isPlaying = !isPlaying
        document.getElementById('playButton').textContent = isPlaying ? 'Pause' : 'Play'

        document.getElementById('keyframeSelector').disabled = isPlaying
        if (isPlaying) {
          lastTimestamp = 0
          requestAnimationFrame(playLoop)
        }
      })

      document.getElementById('keyframeSelector').addEventListener('change', () => {
        const proj = document.getElementById(document.getElementById('projectionSelector').value)
        const keyframes = Array.from(proj.querySelectorAll('vantage-keyframe'))
        const index = parseInt(document.getElementById('keyframeSelector').value, 10)
        if (!isNaN(index) && keyframes[index]) {
          const keyTime = keyframes[index].getAttribute('time')
          document.querySelector('vantage-renderer').setAttribute('time', keyTime)
          document.getElementById('time').value = keyTime
        }
        loadProjectionValues(proj)
      })

      function getActiveKeyframe(projection) {
        const globalTime =
          parseFloat(document.querySelector('vantage-renderer').getAttribute('time')) || 0
        const keyframes = Array.from(projection.querySelectorAll('vantage-keyframe'))
        let active = keyframes[0]
        keyframes.forEach((kf) => {
          const t = parseFloat(kf.getAttribute('time')) || 0
          if (Math.abs(t - globalTime) < 0.0001) {
            active = kf
          } else if (t <= globalTime && t > (parseFloat(active.getAttribute('time')) || 0)) {
            active = kf
          }
        })
        return active
      }

      function getSelectedKeyframe(projection) {
        const keyframes = Array.from(projection.querySelectorAll('vantage-keyframe'))
        const keyframeSelector = document.getElementById('keyframeSelector')
        if (keyframeSelector && keyframeSelector.options.length > 0) {
          const index = parseInt(keyframeSelector.value, 10)
          if (!isNaN(index) && keyframes[index]) return keyframes[index]
        }
        return getActiveKeyframe(projection)
      }

      function populateKeyframeSelector(projection) {
        const keyframeSelector = document.getElementById('keyframeSelector')
        keyframeSelector.innerHTML = ''
        const keyframes = Array.from(projection.querySelectorAll('vantage-keyframe'))
        keyframes.forEach((kf, index) => {
          const option = document.createElement('option')
          option.value = index
          option.text = 'Keyframe ' + (index + 1)
          keyframeSelector.appendChild(option)
        })
      }

      function loadProjectionValues(projection) {
        const keyframe = getSelectedKeyframe(projection)
        if (!keyframe) return
        const pos = (keyframe.getAttribute('position') || '0 0 0').split(' ')
        document.getElementById('posX').value = pos[0]
        document.getElementById('posY').value = pos[1]
        document.getElementById('posZ').value = pos[2]

        const rot = (keyframe.getAttribute('rotation') || '0 0 0').split(' ')
        document.getElementById('rotX').value = rot[0]
        document.getElementById('rotY').value = rot[1]
        document.getElementById('rotZ').value = rot[2]

        document.getElementById('fov').value = keyframe.getAttribute('fov') || ''
        document.getElementById('far').value = keyframe.getAttribute('far') || ''
        document.getElementById('opacity').value = keyframe.getAttribute('opacity') || '1'
        document.getElementById('keyframeTime').value = keyframe.getAttribute('time') || '0'
        const layers = keyframe.getAttribute('layers') || ''
        document.getElementById('layerBuildings').checked = layers.includes('Buildings')
        document.getElementById('layerGround').checked = layers.includes('Ground')
        document.getElementById('layerPlane').checked = keyframe.getAttribute('screen') === 'true'
      }

      document.addEventListener('DOMContentLoaded', () => {
        const selector = document.getElementById('projectionSelector')
        document.querySelectorAll('vantage-projection').forEach((proj) => {
          observeProjection(proj)
        })
        selector.addEventListener('change', () => selectProjection(selector.value))
        selectProjection(selector.value)

        document.querySelector('.controls').addEventListener('input', (e) => {
          if (e.target.matches('input[type="number"], input[type="checkbox"]')) {
            const proj = document.getElementById(selector.value)
            const keyframe = getSelectedKeyframe(proj)
            if (!keyframe) return
            const posX = parseFloat(document.getElementById('posX').value) || 0
            const posY = parseFloat(document.getElementById('posY').value) || 0
            const posZ = parseFloat(document.getElementById('posZ').value) || 0
            keyframe.setAttribute('position', `${posX} ${posY} ${posZ}`)
            const rotX = parseFloat(document.getElementById('rotX').value) || 0
            const rotY = parseFloat(document.getElementById('rotY').value) || 0
            const rotZ = parseFloat(document.getElementById('rotZ').value) || 0
            keyframe.setAttribute('rotation', `${rotX} ${rotY} ${rotZ}`)
            const fov = document.getElementById('fov').value
            if (fov !== '') {
              keyframe.setAttribute('fov', parseFloat(fov))
            } else {
              keyframe.removeAttribute('fov')
            }
            const far = document.getElementById('far').value
            if (far !== '') {
              keyframe.setAttribute('far', parseFloat(far))
            } else {
              keyframe.removeAttribute('far')
            }
            const opacity = document.getElementById('opacity').value
            if (opacity !== '') {
              keyframe.setAttribute('opacity', parseFloat(opacity))
            } else {
              keyframe.removeAttribute('opacity')
            }
            const buildings = document.getElementById('layerBuildings').checked
            const ground = document.getElementById('layerGround').checked
            const screen = document.getElementById('layerPlane').checked
            const newLayers = []
            if (buildings) newLayers.push('Buildings')
            if (ground) newLayers.push('Ground')
            if (newLayers.length) {
              keyframe.setAttribute('layers', newLayers.join(' '))
            } else {
              keyframe.removeAttribute('layers')
            }
            keyframe.setAttribute('screen', screen ? true : false)
            const keyTime = document.getElementById('keyframeTime').value
            keyframe.setAttribute('time', parseFloat(keyTime))
            document.querySelector('vantage-renderer').setAttribute('time', keyTime)
          }
        })
        document.getElementById('keyframeSelector').addEventListener('change', () => {
          const proj = document.getElementById(selector.value)
          const keyframes = Array.from(proj.querySelectorAll('vantage-keyframe'))
          const index = parseInt(document.getElementById('keyframeSelector').value, 10)
          if (!isNaN(index) && keyframes[index]) {
            const keyTime = keyframes[index].getAttribute('time')
            document.querySelector('vantage-renderer').setAttribute('time', keyTime)
          }
          loadProjectionValues(proj)
        })
      })

      function toggleFirstPerson() {
        const renderer = document.querySelector('vantage-renderer')
        const current = renderer.getAttribute('first-person')
        renderer.setAttribute('first-person', current === 'true' ? 'false' : 'true')
      }

      function updateTime(e) {
        const newTime = parseFloat(e.target.value)
        document.querySelector('vantage-renderer').setAttribute('time', newTime)
        const proj = document.getElementById(document.getElementById('projectionSelector').value)
        populateKeyframeSelector(proj)
        loadProjectionValues(proj)
      }

      function selectProjection(id) {
        document.querySelectorAll('vantage-projection').forEach((p) => p.removeAttribute('focus'))
        const projection = document.getElementById(id)
        projection.setAttribute('focus', '')
        populateKeyframeSelector(projection)
        loadProjectionValues(projection)
      }

      function observeProjection(projection) {
        if (projection._observerAttached) return
        projection._observerAttached = true
        const observer = new MutationObserver((mutations) => {
          let updateSelector = false
          mutations.forEach((mutation) => {
            if (mutation.attributeName === 'focus') {
              updateSelector = true
            }
          })
          if (
            updateSelector &&
            projection.hasAttribute('focus') &&
            projection.getAttribute('focus') !== 'false'
          ) {
            document.getElementById('projectionSelector').value = projection.id
          }
          loadProjectionValues(projection)
        })
        observer.observe(projection, { attributes: true, attributeFilter: ['focus'] })
      }

      document.addEventListener('DOMContentLoaded', () => {
        const selector = document.getElementById('projectionSelector')
        document.querySelectorAll('vantage-projection').forEach((proj) => {
          observeProjection(proj)
        })
        selector.addEventListener('change', () => selectProjection(selector.value))
        selectProjection(selector.value)
      })
    </script>
  </body>
  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      font-size: 11px;
      text-rendering: optimizeLegibility;
    }

    section {
      width: 100vw;
      height: 100vh;
    }

    h1,
    h3,
    h4 {
      margin: 5px 0;
      padding: 0;
    }

    .controls div {
      margin: 0 0 20px 0;
    }

    .controls {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #f5f5f5;
      box-shadow: inset 0 0 2px;
      padding: 5px;
      border-radius: 4px;
    }

    .info {
      position: absolute;
      bottom: 0;
      right: 0;
      background-color: white;
      padding: 2px;
      font-size: 12px;
      opacity: 0.7;
    }

    button,
    select {
      margin-top: 10px;
      display: block;
    }
    
    input[type='number'] {
      max-width: 40px;
      display: inline;
    }
  </style>
</html>
